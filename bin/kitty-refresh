#!/usr/bin/env bash
set -euo pipefail

mode="term"
refresh=false

while [[ "${1:-}" == -* ]]; do
    case "$1" in
        -r) refresh=true; shift ;;
        --claude) mode="claude"; shift ;;
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
done

if [[ "$mode" == "claude" ]]; then
    declare -A TABS=(
        [xplr]="⟜ 󰭎  ⊸"
        [claude]="⊰ 󰯉  ⊱"
        [edit]="⊰   ⊱"
        [task]="⊰ ㊋ ⊱"
        [git]="⊰   ⊱"
    )
    declare -A CMDS=(
        [xplr]='xplr'
        [claude]='claude'
        [edit]='nvim'
        [task]=''
        [git]='lazygit'
    )
    TAB_ORDER=(xplr claude edit task git)
    PREFIX="claude-"
    FOCUS_TAB="claude"
    USAGE="kitty-refresh [-r] --claude {claude|edit|task|git|all}"
else
    declare -A TABS=(
        [xplr]="⟜ 󰭎  ⊸"
        [nvim]="⟜   ⊸"
        [term]="⟜   ⊸"
        [build]="⟜   ⊸"
        [git]="⟜   ⊸"
    )
    declare -A CMDS=(
        [nvim]='nvim'
        [term]=''
        [xplr]='xplr'
        [build]='just watch'
        [git]='lazygit'
    )
    TAB_ORDER=(xplr nvim term build git)
    PREFIX=""
    FOCUS_TAB="nvim"
    USAGE="kitty-refresh [-r] {nvim|term|xplr|build|git|all}"
fi

tab="${1:-}"
[[ -z "$tab" ]] && { echo "Usage: $USAGE"; exit 1; }
[[ "$tab" != "all" && -z "${TABS[$tab]:-}" ]] && { echo "Usage: $USAGE"; exit 1; }

kitty_state=$(kitty @ ls)
window_id=$(echo "$kitty_state" | jq -r '.[0].id')
cwd=$(echo "$kitty_state" | jq -r '.[0].tabs[] | select(.is_focused) | .windows[] | select(.is_focused) | .cwd')

get_tab_index() {
    local name="$1"
    local tab_id="${window_id}-${PREFIX}${name}"
    kitty @ ls | jq -r --arg id "$tab_id" '.[0].tabs | to_entries[] | select(.value.windows[0].env.KITTY_TAB_ID == $id) | .key'
}

open_tab() {
    local name="$1"
    local tab_id="${window_id}-${PREFIX}${name}"
    local title="${TABS[$name]}"
    local cmd="${CMDS[$name]}"

    if [[ "$name" == "build" ]]; then
        just --list --justfile "$cwd/justfile" &>/dev/null || { "$refresh" && kitty @ close-tab --match "env:KITTY_TAB_ID=${tab_id}" 2>/dev/null || true; return 0; }
    fi

    if [[ "$name" == "git" ]]; then
        git -C "$cwd" rev-parse --git-dir &>/dev/null || { "$refresh" && kitty @ close-tab --match "env:KITTY_TAB_ID=${tab_id}" 2>/dev/null || true; return 0; }
    fi

    "$refresh" && kitty @ close-tab --match "env:KITTY_TAB_ID=${tab_id}" 2>/dev/null || true

    if [[ -n "$cmd" ]]; then
        kitty @ launch --type=tab --hold --copy-env --env KITTY_TAB_ID="$tab_id" --tab-title="$title" --cwd="$cwd" "$cmd" >/dev/null
    else
        kitty @ launch --type=tab --copy-env --env KITTY_TAB_ID="$tab_id" --tab-title="$title" --cwd="$cwd" >/dev/null
    fi
}

if [[ "$tab" == "all" ]]; then
    for name in "${TAB_ORDER[@]}"; do
        open_tab "$name"
    done
    kitty @ focus-tab --match "env:KITTY_TAB_ID=${window_id}-${PREFIX}${FOCUS_TAB}" 2>/dev/null || true
else
    kitty @ focus-tab --match "env:KITTY_TAB_ID=${window_id}-${PREFIX}${tab}" 2>/dev/null || true
    original_idx=$(get_tab_index "$tab")
    open_tab "$tab"
    new_idx=$(get_tab_index "$tab")
    if [[ -n "$original_idx" && -n "$new_idx" && "$new_idx" -gt "$original_idx" ]]; then
        moves=$((new_idx - original_idx))
        for ((i=0; i<moves; i++)); do
            kitty @ action move_tab_backward
        done
    fi
fi
