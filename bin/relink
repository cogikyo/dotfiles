#!/usr/bin/env bash

# Preserve user's home before sudo changes it to /root
USER_HOME="${USER_HOME:-$HOME}"

# Re-exec with sudo if not root
if [[ $EUID -ne 0 ]]; then
    exec sudo USER_HOME="$HOME" "$0" "$@"
fi

# Symlink most config directories normally
echo "Linking most configs..."
for item in "$USER_HOME"/dotfiles/config/*; do
    name=$(basename "$item")

    # Skip directories that need special handling
    if [[ "$name" == "claude" || "$name" == "Cursor" ]]; then
        continue
    fi

    ln -sfnv "$item" "$USER_HOME/.config/"
done

echo "Linking partial directories..."
# Special handling for claude: symlink to ~/.claude/
mkdir -p "$USER_HOME/.claude"
ln -sfnv "$USER_HOME/dotfiles/config/claude/settings.json" "$USER_HOME/.claude/settings.json"
ln -sfnv "$USER_HOME/dotfiles/config/claude/skills" "$USER_HOME/.claude/skills"
ln -sfnv "$USER_HOME/dotfiles/config/claude/instructions" "$USER_HOME/.claude/instructions"

# Special handling for Cursor: symlink User directory files only
mkdir -p "$USER_HOME/.config/Cursor/User"
ln -sfnv "$USER_HOME/dotfiles/config/Cursor/User/keybindings.json" "$USER_HOME/.config/Cursor/User/keybindings.json"
ln -sfnv "$USER_HOME/dotfiles/config/Cursor/User/settings.json" "$USER_HOME/.config/Cursor/User/settings.json"

echo "Linking bin scripts to /usr/local/bin..."
for script in "$USER_HOME"/dotfiles/bin/*; do
    [[ -x "$script" ]] || continue  # skip non-executables
    ln -sfv "$script" /usr/local/bin/
done
