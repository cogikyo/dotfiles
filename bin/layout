#!/usr/bin/env bash

# === INITIALIZATION ===========================================================

# Workspaces: name|sub|cmd
declare -A WS=(
    [1]="[S] Network|chat, email, calendar|slack"
    [2]="[E] Assist|adjacent tools|tableplus"
    [3]="[T] Master|primary desktop|"
    [4]="[D] Config|settings, dotfiles|"
)

a_flag="" # [a]plication
n_flag="" # [w]orkspace

while getopts 'a:d:n:w:s:' flag; do
    case "$flag" in
    a) a_flag="$OPTARG" ;;
    n) n_flag="$OPTARG" ;;
    *) exit 1 ;;
    esac
done

[[ "$#" == 0 || -z "$n_flag" ]] && exit 1

# Switch workspace IMMEDIATELY before anything else
hyprctl dispatch workspace "$n_flag"

ws_name="${WS[$n_flag]%%|*}"

error() {
    dunstify -a "layout" -u critical -t 2000 "ERROR $ws_name" "$1"
    exit 1
}

inprog=$(ps -ef | rg layout | rg -v rg | wc -l)
if [[ "$inprog" -gt 2 ]]; then
    error "already in progress"
fi

( sleep 5; dunstify -a "layout" -u critical -t 2000 "TIMEOUT" "layout script killed after 5s"; kill $$ 2>/dev/null ) &
WATCHDOG_PID=$!
trap 'kill $WATCHDOG_PID 2>/dev/null' EXIT

# === FUNCTIONS ================================================================

check_windows() {
    windows=$(hyprctl clients -j | jq "[.[] | select(.workspace.id == $n_flag and .pinned == false)] | length")
    if [[ "$windows" -gt 0 ]]; then
        hyprctl dispatch workspace "$n_flag"
        error "already has windows open"
    fi
}

# shellcheck disable=SC2155
arrange_layout() {
    sleep 1.5 # wait for the workspace applicationst to be created

    # Ensures: master → nvim (kitty), slave 1 → firefox, slave 2 → terminal (kitty)
    local ws_id="$n_flag"
    local max_attempts=10
    local attempt=0

    # Wait for 3 windows to appear
    while [[ $attempt -lt $max_attempts ]]; do
        local count
        count=$(hyprctl clients -j | jq --argjson ws "$ws_id" \
            '[.[] | select(.workspace.id == $ws and .floating == false and .class != "GLava")] | length')
        [[ $count -ge 3 ]] && break
        sleep 0.5
        ((attempt++))
    done

    local clients
    clients=$(hyprctl clients -j | jq --argjson ws "$ws_id" \
        '[.[] | select(.workspace.id == $ws and .floating == false and .class != "GLava")]')

    local editor_addr=$(echo "$clients" | jq -r '.[] | select(.class == "kitty" and (.initialTitle == "editor")) | .address' | head -1)
    local firefox_addr=$(echo "$clients" | jq -r '.[] | select(.class | test("firefox"; "i")) | .address' | head -1)
    local kitty_addr=$(echo "$clients" | jq -r '.[] | select(.class == "kitty" and (.initialTitle == "terminal")) | .address' | head -1)

    [[ -z "$editor_addr" || -z "$firefox_addr" || -z "$kitty_addr" ]] && return 1

    # Swap editor to master position
    hyprctl dispatch focuswindow "address:$editor_addr"
    hyprctl dispatch layoutmsg swapwithmaster
    sleep 0.1

    # Get updated positions
    clients=$(hyprctl clients -j | jq --argjson ws "$ws_id" \
        '[.[] | select(.workspace.id == $ws and .floating == false and .class != "GLava")]')

    # Check if firefox is above kitty (slave 1 should be firefox)
    local firefox_y=$(echo "$clients" | jq -r ".[] | select(.address == \"$firefox_addr\") | .at[1]")
    local kitty_y=$(echo "$clients" | jq -r ".[] | select(.address == \"$kitty_addr\") | .at[1]")

    # If kitty is above firefox, swap them
    if [[ $kitty_y -lt $firefox_y ]]; then
        hyprctl dispatch focuswindow "address:$kitty_addr"
        hyprctl dispatch layoutmsg swapnext
    fi

    # Focus back to master (editor)
    hyprctl dispatch focuswindow "address:$editor_addr"
}
# ============================================================================

browser() {
    local urls=("$@")
    [[ ${#urls[@]} -eq 0 ]] && return

    # First URL opens new window - use hyprctl dispatch exec to spawn on current workspace
    hyprctl dispatch exec "firefox-developer-edition --new-window '${urls[0]}'"
    sleep 0.5

    # Remaining URLs open as tabs
    for url in "${urls[@]:1}"; do
        hyprctl dispatch exec "firefox-developer-edition '$url'"
        sleep 0.3
    done
}

editor() {
    local path="$HOME/$1"
    if [[ ! -d "$path" ]]; then
        error "path does not exist: $path"
    fi
    hyprctl dispatch exec "env PROJECT_PATH=$path kitty --title=editor --session ~/.config/kitty/sessions/editor.conf"
    sleep 0.25
}

terminal() {
    local path="$HOME/$1"
    if [[ ! -d "$path" ]]; then
        error "path does not exist: $path"
    fi
    hyprctl dispatch exec "kitty --title=terminal --directory $path --session ~/.config/kitty/sessions/term.conf"
    sleep 0.25
}

dotfiles() {
    editor "dotfiles"
    browser "https://github.com/cogikyo/dotfiles"
    terminal "dotfiles"
}

# === CONFIG ===================================================================

# Apps: path|url1|url2|...
declare -A APP=(
    [a]="cogikyo/acr|localhost:3002"
    [n]="cogikyo/cogikyo.com|localhost:3000"
    [l]="LeadPier|http://localhost:4000"
    [h]="projects/hgmx-builder|https://github.com/cogikyo/hgmx-builder|http://localhost:8003"
    [z]="projects/kaizen|https://github.com/cogikyo/kaizen"
)

# === MAIN =====================================================================

main() {
    local ws_entry="${WS[$n_flag]}"
    [[ -z "$ws_entry" ]] && error "invalid workspace"

    IFS='|' read -r layout_name layout_sub ws_cmd <<< "$ws_entry"

    local app_path sub_msg
    if [[ -n "$a_flag" ]]; then
        local app_entry="${APP[$a_flag]}"
        [[ -z "$app_entry" ]] && error "invalid application: $a_flag"
        app_path="${app_entry%%|*}"
        sub_msg="opening $app_path"
    else
        sub_msg="opening $layout_sub"
    fi

    # hyprctl keyword input:follow_mouse 0
    check_windows

    dunstify -a "layout" -u low "$layout_name" "$sub_msg"

    case "$n_flag" in
    1 | 2)
        hyprctl dispatch exec "$ws_cmd"
        sleep 0.5
        ;;
    3)
        editor "$app_path"
        IFS='|' read -ra parts <<< "${APP[$a_flag]}"
        browser "${parts[@]:1}"
        terminal "$app_path"
        ;;
    4)
        dotfiles
        ;;
    esac

    if [[ "$n_flag" -eq 3 || "$n_flag" -eq 4 ]]; then
        split -d
        arrange_layout
        resize-slave
    fi

    # hyprctl keyword input:follow_mouse 1
    dunstify -a "layout" -u low "$layout_name" "$sub_msg completed"
}

main
exit 0
