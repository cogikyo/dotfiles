#!/usr/bin/env bash

# === INITIALIZATION ===========================================================

error() {
    dunstify -a "layout" -u critical -t 2000 "ERROR $n_flag" "$1"
    exit 1
}


a_flag="" # [a]plication
n_flag="" # [w]orkspace
# s_flag="" # [s]ession (kitty)
# w_flag="" # [w]ebsite

while getopts 'a:d:n:w:s:' flag; do
    case "$flag" in
    a) a_flag="$OPTARG" ;;
    # s) s_flag="$OPTARG" ;;
    n) n_flag="$OPTARG" ;;
        # w) w_flag="$OPTARG" ;;
    *) exit 1 ;;
    esac
done

if [[ "$#" == 0 ]]; then
    error "no workspace specified"
fi

inprog=$(ps -ef | rg layout | rg -v rg | wc -l)
if [[ "$inprog" -gt 2 ]]; then
    error "already in progress"
fi

# === FUNCTIONS ================================================================

check_windows() {
    windows=$(hyprctl clients -j | jq "[.[] | select(.workspace.id == $n_flag and .pinned == false)] | length")
    if [[ "$windows" -gt 0 ]]; then
        hyprctl dispatch workspace "$n_flag"
        error "already has windows open"
    fi
}

# shellcheck disable=SC2155
arrange_layout() {
    sleep 2 # wait for the workspace to be created

    # Ensures: master → cursor, slave 1 → firefox, slave 2 → terminal
    local ws_id="$n_flag"
    local max_attempts=10
    local attempt=0

    # Wait for 3 windows to appear
    while [[ $attempt -lt $max_attempts ]]; do
        local count
        count=$(hyprctl clients -j | jq "[.[] | select(.workspace.id == $ws_id and .floating == false)] | length")
        [[ $count -ge 3 ]] && break
        sleep 0.5
        ((attempt++))
    done

    local clients=$(hyprctl clients -j | jq "[.[] | select(.workspace.id == $ws_id and .floating == false)]")
    
    local cursor_addr=$(echo "$clients" | jq -r '.[] | select(.class == "cursor") | .address' | head -1)
    local firefox_addr=$(echo "$clients" | jq -r '.[] | select(.class | test("firefox"; "i")) | .address' | head -1)
    local kitty_addr=$(echo "$clients" | jq -r '.[] | select(.class == "kitty") | .address' | head -1)

    [[ -z "$cursor_addr" || -z "$firefox_addr" || -z "$kitty_addr" ]] && return 1

    # Swap cursor to master position
    hyprctl dispatch focuswindow "address:$cursor_addr"
    hyprctl dispatch layoutmsg swapwithmaster master
    sleep 0.1

    # Get updated positions
    clients=$(hyprctl clients -j | jq "[.[] | select(.workspace.id == $ws_id and .floating == false)]")

    # Check if firefox is above kitty (slave 1 should be firefox)
    local firefox_y=$(echo "$clients" | jq -r ".[] | select(.address == \"$firefox_addr\") | .at[1]")
    local kitty_y=$(echo "$clients" | jq -r ".[] | select(.address == \"$kitty_addr\") | .at[1]")

    # If kitty is above firefox, swap them
    if [[ $kitty_y -lt $firefox_y ]]; then
        hyprctl dispatch focuswindow "address:$kitty_addr"
        hyprctl dispatch layoutmsg swapnext
    fi

    # Focus back to master (cursor)
    hyprctl dispatch focuswindow "address:$cursor_addr"
}
# ============================================================================

browser() {
    if [[ "$2" == "tab" ]]; then
        firefox-developer-edition "$1" &
        sleep 1.5
    else
        firefox-developer-edition --new-window "$1" &
        sleep 1.5
    fi
}

terminal() {
    local path="$HOME/$1"
    if [[ ! -d "$path" ]]; then
        error "path does not exist: $path"
    fi
    case "$1" in
        dotfiles)
            kitty --session ~/.config/kitty/sessions/dotfiles.conf 
            ;;
        default)
            PROJECT_PATH="$path" kitty --session ~/.config/kitty/sessions/default.conf 
            ;;
    esac;
    sleep 0.25
}

cogikyo() {
    cursor "$HOME/nosvagor.com"
    browser "localhost:3000"
}

acr() {
    cursor "$HOME/acr"
    browser "localhost:3002"
    terminal "acr"
}

leadPier () {
    cursor "$HOME/LeadPier"
    browser "http://localhost:4000" 
    terminal "LeadPier"
}

hgmx() {
    # cursor "$HOME/hgmx-builder"
    terminal "hgmx-builder"
    # sleep 1
    # browser "http://localhost:8003"
}

dotfiles() {
    cursor "$HOME/dotfiles"
    browser "https://github.com/cogikyo/dotfiles"
    terminal "dotfiles"
}

# === MAIN =====================================================================

main() {
    hyprctl keyword input:follow_mouse 0

    check_windows
    hyprctl dispatch workspace "$n_flag"

    case "$n_flag" in
    1)
        dunstify -a "layout" -u low "S" "opening networking"
        slack & sleep 0.5
        ;;
    2)
        dunstify -a "layout" -u low "E" "opening adjacent tools"
        tableplus & sleep 0.5
        ;;
    3)
        dunstify -a "layout" -u low "T" "opening main workspace"
        case "$a_flag" in
            "a") acr ;;
            "n") cogikyo ;;
            "l") leadPier ;;
            "h") hgmx ;;
        esac
        ;;
    4) 
        dunstify -a "layout" -u low "D" "opening settings"
        dotfiles
        ;;
    *) error "invalid workspace" ;;
    esac

    if [[ "$n_flag" -eq 3 || "$n_flag" -eq 4 ]]; then
        split -d
        arrange_layout
        resize-slave
    fi

    hyprctl keyword input:follow_mouse 1
}

main
exit 0
