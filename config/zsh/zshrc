[ -f "$HOME/.config/shell/env.sh" ] && source "$HOME/.config/shell/env.sh"

export TERM=xterm-256color
export GOPRIVATE=*.linecode.net,*.linecode.dev
export GONOSUMDB=*.linecode.net,*.linecode.dev
export PATH="/opt/homebrew/opt/postgresql@17/bin:$PATH"
export PATH="$HOME/go/bin:$PATH"
export PATH="/usr/local/go/bin:$PATH"
export PATH="$HOME/.cargo/bin:$PATH"
export GOPATH="$HOME/.go"
export PATH="$PATH:$HOME/.go/bin"
export PATH="$HOME/.local/bin:$PATH"
export PATH="$HOME/dotfiles/bin:$PATH"

eval "$(starship init zsh)"
eval "$(zoxide init zsh)"

function command_not_found_handler {
    return 127
}


# history
HISTFILE=~/.histfile
HISTSIZE=1000
SAVEHIST=800
setopt INC_APPEND_HISTORY
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_IGNORE_DUPS
setopt AUTO_CD

# aliases
alias niol='clear && source ~/.zshrc'
alias ls='echo; lsd'
alias n='nvim'
alias c='claude'
alias zz='cd ~'
alias m="make"
alias j="just"
alias l='cd ~/LeadPier'
alias p='cd ~/LeadPier/services/partner'
alias jt="just test"
alias jr="just req"
alias jw="just watch"
alias g='cd "$(xplr --print-pwd-as-result)"'
alias rh='git reset --soft HEAD^'
alias d='cd ~/dotfiles'
alias D='cd ~/downloads'
alias v='cd ~/vagari'
alias e='cd ~/dotfiles/config/nvim'
alias x='exit'
alias k='kaizen'
alias lg='lazygit --use-config-file="$HOME/dotfiles/config/lazygit/config.yml"'
alias ld='lazydocker'
alias uvpn='nmcli connection up "TrendCapitalVPN"'
alias dvpn='nmcli connection down "TrendCapitalVPN"'
ivpn() {
    local file="$1"
    [[ -f "$file" ]] || { echo "No such file: $1"; return 1; }

    # Force .conf extension if missing
    [[ "$file" != *.conf ]] && file="$file.conf"
    [[ -f "$file" ]] || { echo "Still no file: $file"; return 1; }

    local name=$(grep -m1 '^id=' "$file" | cut -d= -f2- | xargs)
    [[ -z "$name" ]] && name=$(basename "$file" .conf)

    echo "Importing â†’ $name"
    sudo nmcli connection import type l2tp file "$file" || return 1

    echo "\nAvailable VPN connectios:"
    nmcli connection show | grep -E "(vpn|l2tp)" | grep -v "^--"

    echo "\nAuthenticate with:"
    echo "\nnmcli connection up \"$name\" --ask"
}

alias update='paru -Syu && paru -Qqe > ~/dotfiles/etc/packages.lst'
alias oc='ouch compress'
alias od='ouch decompress'
alias ol='ouch list --tree'
alias man='man --pager=$PAGER'
alias zoomfix='env XDG_CURRENT_DESKTOP=GNOME GDK_BACKEND=x11 QT_QPA_PLATFORM=xcb XDG_SESSION_TYPE=x11 zoom & disown'
alias af='GDK_BACKEND=x11 QT_QPA_PLATFORM=xcb audacity & disown'
function etree () {
    echo
    if [[ -z $1 ]]; then
        L=2
    else
        L=$1
    fi
    erd -L "$L" --suppress-size --threads 16 --layout inverted
}

function mgif() {
    local files=(~/Desktop/Screen\ Recording*.mov(Om))
    if [[ ${#files} -eq 0 ]]; then
        echo "No screen recording found on Desktop"
        return 1
    fi
    local latest_recording="${files[-1]}"
    if [[ ! -f "$latest_recording" ]]; then
        echo "Error: File not found: $latest_recording"
        return 1
    fi
    local output_name=$(basename "$latest_recording" .mov).gif
    local output_path="$HOME/Documents/gifs/$output_name"
    mkdir -p ~/Documents/gifs

    if [[ "$1" == "hq" || "$1" == "high" ]]; then
        local fps=20
        local scale=1600:-1
        local max_colors=256
        local dither=sierra2_4a
        echo "Converting (HIGH QUALITY) $latest_recording to $output_path..."
        local vf_filter="fps=${fps},scale=${scale}:flags=lanczos,split[s0][s1];[s0]palettegen=max_colors=${max_colors}[p];[s1][p]paletteuse=dither=${dither}"
    else
        local fps=16
        local scale=1000:-1
        local max_colors=256
        local dither=bayer
        echo "Converting $latest_recording to $output_path..."
        local vf_filter="fps=${fps},scale=${scale}:flags=lanczos,split[s0][s1];[s0]palettegen=max_colors=${max_colors}[p];[s1][p]paletteuse=dither=${dither}"
    fi

    local error_output
    if error_output=$(ffmpeg -i "$latest_recording" -vf "$vf_filter" -y "$output_path" 2>&1); then
        if [[ ! -f "$output_path" ]]; then
            echo "Error: Conversion appeared to succeed but output file not found"
            echo "$error_output" | tail -20
            return 1
        fi
        local size=$(du -h "$output_path" | cut -f1)
        local duration=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$output_path" 2>/dev/null | awk '{printf "%.1f", $1}')
        echo "Done! GIF saved to $output_path"
        echo "Size: $size | Duration: ${duration}s"
        open -a "Firefox Developer Edition" "$output_path"
    else
        echo "Error: Conversion failed"
        echo "$error_output" | tail -20
        return 1
    fi
}

alias ew='eww-open'
alias ews='eww inspector & disown && exit'
alias el='eww logs'

# plugins
if [[ ! -f ${ZDOTDIR:-${HOME}}/.zcomet/bin/zcomet.zsh ]]; then
    command git clone https://github.com/agkozak/zcomet.git ${ZDOTDIR:-${HOME}}/.zcomet/bin
fi
source ${ZDOTDIR:-${HOME}}/.zcomet/bin/zcomet.zsh

zcomet load zsh-users/zsh-completions
zcomet load zsh-users/zsh-autosuggestions
zcomet load marlonrichert/zsh-autocomplete
zcomet load zsh-users/zsh-syntax-highlighting

autoload -U compinit; compinit

ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20

# fix keys
bindkey -v
export KEYTIMEOUT=01
bindkey '^[[H'     vi-beginning-of-line
bindkey '^[[F'     vi-end-of-line
bindkey '^[[3~'    delete-char
bindkey '^[[1;5C'  forward-word   # C-left
bindkey '^[[1;5D'  backward-word  # C-right
bindkey '^[[1;5A'  history-incremental-search-backward # C-up
bindkey '^[[1;5B'  history-incremental-search-forward  # C-down

source $HOME/.config/zsh/vagari-highlights.zsh
